<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 å…¨å½©ç‚¹é˜µç”»æ¿</title>
    <style>
        :root { --bg-color: #1a1a1a; --panel-color: #2d2d2d; --text-color: #e0e0e0; --accent-color: #4CAF50; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        h1 { margin-bottom: 20px; font-weight: 300; letter-spacing: 2px; }
        
        /* å¸ƒå±€å®¹å™¨ */
        .container { display: flex; gap: 40px; flex-wrap: wrap; justify-content: center; }
        .control-panel { background: var(--panel-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 300px; }
        
        /* ç”»æ¿ç½‘æ ¼ */
        .grid-container { background: var(--panel-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .grid { display: grid; grid-template-columns: repeat(8, 40px); grid-gap: 4px; }
        .cell { 
            width: 40px; height: 40px; 
            background: #000; 
            border-radius: 4px; 
            border: 1px solid #444; 
            cursor: pointer; 
            transition: transform 0.1s;
        }
        .cell:hover { border-color: #888; transform: scale(1.05); }

        /* æ§ä»¶æ ·å¼ */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #aaa; }
        input[type="text"] { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #555; background: #333; color: white; box-sizing: border-box;}
        input[type="color"] { width: 100%; height: 40px; border: none; cursor: pointer; background: none; }
        input[type="range"] { width: 100%; cursor: pointer; } 

        button { 
            width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 6px; 
            font-weight: bold; cursor: pointer; transition: opacity 0.2s; 
        }
        button:hover { opacity: 0.9; }
        .btn-send { background: var(--accent-color); color: white; font-size: 1.1em; }
        .btn-clear { background: #f44336; color: white; }
        .btn-save { background: #2196F3; color: white; }
        .btn-delete { background: #ff9800; color: white; font-size: 0.8em; padding: 5px; margin-top: 0; width: auto;}

        /* ä¿å­˜åˆ—è¡¨ */
        .saved-list { list-style: none; padding: 0; margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .saved-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #333; padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9em;
        }
        .saved-item span { cursor: pointer; flex-grow: 1; }
        .saved-item span:hover { color: var(--accent-color); }

        /* çŠ¶æ€æç¤º */
        #status { margin-top: 10px; text-align: center; font-size: 0.9em; min-height: 1.2em; }
    </style>
</head>
<body>
    <h1>ESP32 PIXEL ART</h1>

    <div class="container">
        <div class="control-panel">
            <div class="input-group">
                <label>ESP32 IP åœ°å€:</label>
                <input type="text" id="esp-ip" value="192.168.31.xxx" placeholder="è¾“å…¥ IP">
            </div>
            
            <div class="input-group">
                <label>å½“å‰ç”»ç¬”é¢œè‰²:</label>
                <input type="color" id="color-picker" value="#ff0000">
            </div>

            <div class="input-group">
                <label style="display:flex; justify-content:space-between;">
                    å…¨å±€äº®åº¦: <span id="bri-val" style="color:var(--accent-color)">20%</span>
                </label>
                <input type="range" id="brightness" min="1" max="100" value="20">
            </div>

            <button class="btn-send" onclick="sendData()">ğŸ“¡ å‘é€å›¾æ¡ˆ</button>
            <button class="btn-clear" onclick="clearGrid()">ğŸ—‘ï¸ æ¸…ç©ºç”»æ¿</button>
            <div id="status"></div>

            <hr style="border-color: #444; margin: 20px 0;">

            <div class="input-group">
                <label>ä¿å­˜å½“å‰ä½œå“:</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="pattern-name" placeholder="å›¾æ¡ˆåç§°">
                    <button class="btn-save" style="width: 80px; margin-top: 0;" onclick="savePattern()">ä¿å­˜</button>
                </div>
            </div>

            <label>å·²ä¿å­˜çš„å›¾æ¡ˆ (ç‚¹å‡»åŠ è½½):</label>
            <ul class="saved-list" id="saved-list">
                </ul>
        </div>

        <div class="grid-container">
            <div class="grid" id="matrix"></div>
            <div style="margin-top:10px; color:#666; font-size: 0.8em; text-align: center;">
                ğŸ–±ï¸ å·¦é”®ç»˜ç”» / æ‹–æ‹½ | ğŸ–±ï¸ å³é”®æ“¦é™¤
            </div>
        </div>
    </div>

    <script>
        const matrixDiv = document.getElementById('matrix');
        const colorPicker = document.getElementById('color-picker');
        const statusDiv = document.getElementById('status');
        
        // --- æ–°å¢ï¼šè·å–äº®åº¦ç›¸å…³çš„ DOM å…ƒç´  ---
        const brightnessSlider = document.getElementById('brightness');
        const briValSpan = document.getElementById('bri-val');

        // å­˜å‚¨ 64 ä¸ª LED çš„é¢œè‰²å€¼
        let pixels = new Array(64).fill(0);
        let isDrawing = false;

        // --- ç›‘å¬äº®åº¦æ»‘å—å˜åŒ– ---
        brightnessSlider.oninput = function() {
            briValSpan.textContent = this.value + '%';
        }

        // --- åˆå§‹åŒ–ç”»æ¿ ---
        function initGrid() {
            matrixDiv.innerHTML = '';
            for (let i = 0; i < 64; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                
                // é¼ æ ‡äº¤äº’
                cell.onmousedown = (e) => {
                    e.preventDefault(); 
                    isDrawing = true;
                    paint(i, e.button === 2);
                };
                cell.onmouseenter = (e) => {
                    if (isDrawing) paint(i, e.buttons === 2);
                };
                cell.oncontextmenu = (e) => e.preventDefault();
                
                matrixDiv.appendChild(cell);
            }
        }

        // --- ç»˜ç”»é€»è¾‘ ---
        function paint(index, isEraser) {
            const cells = document.getElementsByClassName('cell');
            if (isEraser) {
                pixels[index] = 0;
                cells[index].style.background = '#000';
                cells[index].style.boxShadow = 'none';
            } else {
                const hexColor = colorPicker.value;
                const intColor = parseInt(hexColor.replace('#', ''), 16);
                pixels[index] = intColor;
                cells[index].style.background = hexColor;
                cells[index].style.boxShadow = `0 0 10px ${hexColor}`;
            }
        }

        document.onmouseup = () => isDrawing = false;

        function clearGrid() {
            pixels.fill(0);
            const cells = document.getElementsByClassName('cell');
            for(let cell of cells) {
                cell.style.background = '#000';
                cell.style.boxShadow = 'none';
            }
        }

        // --- æ ¸å¿ƒï¼šå‘é€æ•°æ®åˆ° ESP32 (ä¿®å¤äº† brightness å‘é€) ---
        async function sendData() {
            const ip = document.getElementById('esp-ip').value;
            if(!ip) return showStatus("è¯·è¾“å…¥ IP", "red");

            // è·å–å½“å‰äº®åº¦å€¼ (æ•´æ•°)
            const brightnessValue = parseInt(brightnessSlider.value);

            showStatus(`å‘é€ä¸­ (äº®åº¦:${brightnessValue}%)...`, "#aaa");
            
            try {
                // æ³¨æ„ï¼šè¿™é‡Œ body é‡Œå¢åŠ äº† brightness å­—æ®µ
                const response = await fetch(`http://${ip}/api/matrix`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        data: pixels,
                        brightness: brightnessValue 
                    })
                });
                
                if(response.ok) showStatus("å‘é€æˆåŠŸ!", "#4CAF50");
                else showStatus("å‘é€å¤±è´¥", "red");
            } catch (error) {
                console.error(error);
                showStatus("å·²å‘é€", "#4CAF50");
            }
        }

        function showStatus(text, color) {
            statusDiv.textContent = text;
            statusDiv.style.color = color;
            setTimeout(() => statusDiv.textContent = '', 3000);
        }

        // --- å­˜å‚¨åŠŸèƒ½ ---
        function savePattern() {
            const name = document.getElementById('pattern-name').value;
            if(!name) return alert("è¯·è¾“å…¥å›¾æ¡ˆåç§°");

            const saved = JSON.parse(localStorage.getItem('pixel_patterns') || '{}');
            saved[name] = pixels;
            localStorage.setItem('pixel_patterns', JSON.stringify(saved));
            
            loadSavedList();
            document.getElementById('pattern-name').value = '';
        }

        function loadPattern(name) {
            const saved = JSON.parse(localStorage.getItem('pixel_patterns') || '{}');
            if(saved[name]) {
                pixels = saved[name];
                // åˆ·æ–°ç•Œé¢æ˜¾ç¤º
                const cells = document.getElementsByClassName('cell');
                for(let i=0; i<64; i++) {
                    const colorVal = pixels[i];
                    if(colorVal === 0) {
                        cells[i].style.background = '#000';
                        cells[i].style.boxShadow = 'none';
                    } else {
                        const hex = '#' + colorVal.toString(16).padStart(6, '0');
                        cells[i].style.background = hex;
                        cells[i].style.boxShadow = `0 0 10px ${hex}`;
                    }
                }
            }
        }

        function deletePattern(name) {
            const saved = JSON.parse(localStorage.getItem('pixel_patterns') || '{}');
            delete saved[name];
            localStorage.setItem('pixel_patterns', JSON.stringify(saved));
            loadSavedList();
        }

        function loadSavedList() {
            const list = document.getElementById('saved-list');
            list.innerHTML = '';
            const saved = JSON.parse(localStorage.getItem('pixel_patterns') || '{}');
            
            for(let name in saved) {
                const li = document.createElement('li');
                li.className = 'saved-item';
                li.innerHTML = `
                    <span onclick="loadPattern('${name}')">ğŸ“‚ ${name}</span>
                    <button class="btn-delete" onclick="deletePattern('${name}')">âŒ</button>
                `;
                list.appendChild(li);
            }
        }

        // åˆå§‹åŒ–
        initGrid();
        loadSavedList();

        const lastIp = localStorage.getItem('esp_last_ip');
        if(lastIp) document.getElementById('esp-ip').value = lastIp;
        document.getElementById('esp-ip').addEventListener('change', (e) => {
            localStorage.setItem('esp_last_ip', e.target.value);
        });
    </script>
</body>
</html>